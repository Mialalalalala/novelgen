<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovelGen ‚ú® AI Â∞èËØ¥ÂÆáÂÆô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --grad-purple: #667eea;
      --grad-pink: #f093fb;
      --grad-coral: #f5576c;
      --grad-cyan: #4facfe;
      --bg-deep: #07060f;
      --glass-bg: rgba(255,255,255,0.06);
      --glass-bg-hover: rgba(255,255,255,0.1);
      --glass-border: rgba(255,255,255,0.10);
      --glass-border-hover: rgba(240,147,251,0.45);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.65);
      --text-muted: rgba(255,255,255,0.35);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* Ambient glow background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 15% 15%, rgba(102,126,234,0.18) 0%, transparent 50%),
        radial-gradient(ellipse at 85% 10%, rgba(240,147,251,0.13) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 85%, rgba(245,87,108,0.09) 0%, transparent 50%),
        radial-gradient(ellipse at 90% 75%, rgba(79,172,254,0.10) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* Fixed orbs for depth */
    .orb {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      filter: blur(80px);
    }
    .orb-1 {
      width: 700px; height: 700px;
      background: radial-gradient(circle, rgba(102,126,234,0.08) 0%, transparent 70%);
      top: -200px; left: -150px;
    }
    .orb-2 {
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(240,147,251,0.07) 0%, transparent 70%);
      bottom: -100px; right: -100px;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 24px;
      position: relative;
      z-index: 1;
    }

    /* ===== HEADER ===== */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(24px);
      background: rgba(7,6,15,0.7);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 20px rgba(102,126,234,0.5);
      flex-shrink: 0;
    }

    .brand-name {
      font-size: 20px;
      font-weight: 900;
      background: linear-gradient(90deg, #a78bfa, #f093fb, #f5576c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .brand-tagline {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 300;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(74,222,128,0.1);
      border: 1px solid rgba(74,222,128,0.25);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 11px;
      color: #4ade80;
      font-weight: 500;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulseDot 2s infinite;
    }

    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.8); }
    }

    /* ===== HERO ===== */
    .hero {
      text-align: center;
      padding: 72px 0 48px;
      position: relative;
      z-index: 1;
    }

    .hero-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(102,126,234,0.12);
      border: 1px solid rgba(102,126,234,0.25);
      border-radius: 20px;
      padding: 7px 18px;
      font-size: 12px;
      color: #a78bfa;
      font-weight: 500;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
    }

    .hero-title {
      font-size: clamp(30px, 5vw, 56px);
      font-weight: 900;
      line-height: 1.15;
      margin-bottom: 18px;
      letter-spacing: -1.5px;
    }

    .gradient-text {
      background: linear-gradient(90deg, #a78bfa 0%, #f093fb 45%, #f5576c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      max-width: 460px;
      margin: 0 auto 36px;
      font-weight: 300;
      line-height: 1.8;
    }

    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 16px;
    }

    .hero-stat {
      text-align: center;
    }

    .hero-stat-num {
      font-size: 26px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--grad-purple), var(--grad-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== SECTION LABEL ===== */
    .section-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, rgba(255,255,255,0.08), transparent);
    }

    /* ===== NOVELS GRID ===== */
    .novels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 80px;
      position: relative;
      z-index: 1;
    }

    /* ===== NOVEL CARD ===== */
    .novel-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      backdrop-filter: blur(20px);
      position: relative;
      group: true;
    }

    .novel-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(102,126,234,0.06), rgba(240,147,251,0.04));
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .novel-card:hover::after { opacity: 1; }

    .novel-card:hover {
      transform: translateY(-8px) scale(1.015);
      border-color: rgba(240,147,251,0.35);
      box-shadow:
        0 24px 60px rgba(102,126,234,0.18),
        0 0 0 1px rgba(240,147,251,0.15),
        inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .novel-cover-wrapper {
      position: relative;
      width: 100%;
      height: 210px;
      overflow: hidden;
    }

    .novel-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .novel-card:hover .novel-cover {
      transform: scale(1.06);
    }

    .novel-cover-fallback {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1040 0%, #667eea 50%, #f093fb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 52px;
    }

    .novel-cover-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(7,6,15,0.85) 0%, rgba(7,6,15,0.1) 50%, transparent 100%);
    }

    .novel-genre-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(240,147,251,0.9));
      color: white;
      padding: 4px 11px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 12px rgba(102,126,234,0.4);
    }

    .novel-info {
      padding: 14px 16px 16px;
    }

    .novel-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .novel-author {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .novel-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .novel-price {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(90deg, #a78bfa, #f093fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .novel-cta {
      background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(240,147,251,0.25));
      border: 1px solid rgba(167,139,250,0.35);
      color: #c4b5fd;
      padding: 7px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s;
      font-family: inherit;
    }

    .novel-cta:hover {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 18px rgba(102,126,234,0.5);
    }

    /* ===== LOADING / EMPTY ===== */
    .loading {
      text-align: center;
      padding: 100px 20px;
      color: var(--text-secondary);
      position: relative;
      z-index: 1;
    }

    .loading-spinner {
      width: 44px;
      height: 44px;
      border: 2px solid rgba(255,255,255,0.08);
      border-top-color: var(--grad-purple);
      border-right-color: var(--grad-pink);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
      position: relative;
      z-index: 1;
    }

    .empty-state h2 {
      font-size: 22px;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-weight: 700;
    }

    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(12px);
    }

    .modal-content {
      background: rgba(12,10,28,0.97);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 28px;
      padding: 32px;
      max-width: 880px;
      width: 100%;
      margin: auto;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(40px);
      box-shadow:
        0 48px 96px rgba(0,0,0,0.6),
        0 0 0 1px rgba(255,255,255,0.04),
        inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      padding-right: 16px;
    }

    .close-btn {
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
      width: 34px;
      height: 34px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.14);
      color: white;
      border-color: rgba(255,255,255,0.18);
    }

    /* ===== MODAL NOVEL INFO ===== */
    .modal-novel-info {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .modal-cover {
      width: 110px;
      height: 148px;
      border-radius: 12px;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }

    .modal-cover-placeholder {
      width: 110px;
      height: 148px;
      border-radius: 12px;
      flex-shrink: 0;
      background: linear-gradient(135deg, #1a1040, #667eea, #f093fb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .modal-novel-details { flex: 1; }

    .modal-novel-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .meta-chip {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 8px;
      padding: 4px 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .meta-chip.genre {
      background: rgba(167,139,250,0.15);
      border-color: rgba(167,139,250,0.25);
      color: #c4b5fd;
    }

    .modal-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.75;
      margin-top: 10px;
    }

    /* ===== INTERACTIVE SECTION ===== */
    .interactive-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin: 20px 0;
    }

    @media (max-width: 600px) {
      .interactive-section { grid-template-columns: 1fr; }
    }

    .feature-card {
      background: linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(240,147,251,0.08) 100%);
      border: 1px solid rgba(102,126,234,0.22);
      border-radius: 20px;
      padding: 20px;
      color: white;
      backdrop-filter: blur(20px);
    }

    .feature-card h3 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    /* Image type buttons */
    .img-type-btn {
      background: rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 5px 11px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .img-type-btn:hover {
      background: rgba(255,255,255,0.13);
      color: white;
    }

    .img-type-btn.active {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      color: white;
      border-color: transparent;
      box-shadow: 0 3px 12px rgba(102,126,234,0.45);
    }

    /* Inputs inside cards */
    .feature-input {
      width: 100%;
      padding: 11px 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      font-size: 12px;
      color: white;
      margin-bottom: 10px;
      font-family: inherit;
      resize: none;
      transition: border-color 0.2s;
    }

    .feature-input::placeholder { color: rgba(255,255,255,0.28); }

    .feature-input:focus {
      outline: none;
      border-color: rgba(102,126,234,0.45);
    }

    .feature-btn {
      background: rgba(255,255,255,0.95);
      color: var(--grad-purple);
      border: none;
      padding: 11px 18px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      font-family: inherit;
    }

    .feature-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255,255,255,0.2);
    }

    .feature-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
    }

    .generated-image-container {
      margin-top: 12px;
      text-align: center;
    }

    .generated-image {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
    }

    /* ===== CHARACTER CHAT ===== */
    .character-chat-section {
      background: linear-gradient(135deg, rgba(102,126,234,0.10) 0%, rgba(240,147,251,0.07) 100%);
      border: 1px solid rgba(102,126,234,0.18);
      border-radius: 24px;
      padding: 24px;
      margin: 16px 0;
      color: white;
    }

    .character-chat-section h3 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 17px;
      font-weight: 700;
    }

    .role-selection {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .role-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s;
      color: rgba(255,255,255,0.6);
      font-family: inherit;
    }

    .role-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      transform: translateY(-2px);
    }

    .role-btn.active {
      background: linear-gradient(135deg, rgba(102,126,234,0.35), rgba(240,147,251,0.25));
      border-color: rgba(167,139,250,0.45);
      color: white;
      box-shadow: 0 4px 20px rgba(102,126,234,0.3);
    }

    .role-icon { font-size: 22px; }
    .role-name { font-size: 11px; font-weight: 600; }

    /* Character stage */
    .character-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .character-container {
      position: relative;
      width: 200px;
      height: 280px;
      margin-bottom: 16px;
    }

    .character-wrapper {
      position: relative;
      width: 200px;
      height: 250px;
      animation: idleBreath 4s ease-in-out infinite;
    }

    .character-wrapper.thinking { animation: thinkingMotion 2s ease-in-out infinite; }
    .character-wrapper.speaking { animation: speakingMotion 0.3s ease-in-out infinite; }

    @keyframes idleBreath {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-3px) scale(1.01); }
    }

    @keyframes thinkingMotion {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-2px) rotate(-2deg); }
      75% { transform: translateY(-2px) rotate(2deg); }
    }

    @keyframes speakingMotion {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-2px) scale(1.02) rotate(-1deg); }
      50% { transform: translateY(-4px) scale(1.01); }
      75% { transform: translateY(-2px) scale(1.02) rotate(1deg); }
    }

    .character-image {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(167,139,250,0.5);
      box-shadow:
        0 0 0 6px rgba(102,126,234,0.12),
        0 8px 40px rgba(102,126,234,0.4);
    }

    .character-mouth {
      position: absolute;
      bottom: 55px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 8px;
      background: rgba(255,255,255,0.15);
      border-radius: 50%;
      opacity: 0;
      transition: all 0.1s;
    }

    .character-wrapper.speaking .character-mouth {
      opacity: 1;
      animation: mouthMove 0.2s ease-in-out infinite;
    }

    @keyframes mouthMove {
      0%, 100% { height: 8px; width: 30px; border-radius: 50%; }
      50% { height: 16px; width: 24px; border-radius: 50%; }
    }

    .character-eyes {
      position: absolute;
      top: 75px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 40px;
    }

    .character-eye {
      width: 8px;
      height: 8px;
      background: transparent;
      border-radius: 50%;
      animation: blink 4s infinite;
    }

    @keyframes blink {
      0%, 95%, 100% { transform: scaleY(1); }
      97% { transform: scaleY(0.1); }
    }

    .sound-waves {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      align-items: flex-end;
      height: 20px;
      opacity: 0;
    }

    .character-wrapper.speaking .sound-waves { opacity: 1; }

    .sound-wave {
      width: 4px;
      background: linear-gradient(to top, var(--grad-purple), var(--grad-pink));
      border-radius: 2px;
      animation: soundWave 0.5s ease-in-out infinite;
    }

    .sound-wave:nth-child(1) { animation-delay: 0s; }
    .sound-wave:nth-child(2) { animation-delay: 0.1s; }
    .sound-wave:nth-child(3) { animation-delay: 0.2s; }
    .sound-wave:nth-child(4) { animation-delay: 0.1s; }
    .sound-wave:nth-child(5) { animation-delay: 0s; }

    @keyframes soundWave {
      0%, 100% { height: 8px; }
      50% { height: 20px; }
    }

    .character-speaking-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #4ade80, #22d3ee);
      border-radius: 50%;
      display: none;
      animation: pulse 1s infinite;
      box-shadow: 0 0 12px rgba(74,222,128,0.6);
    }

    .character-speaking-indicator.active { display: block; }

    .emotion-particles {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      font-size: 16px;
      opacity: 0;
    }

    .character-wrapper.speaking .particle {
      animation: floatUp 2s ease-out infinite;
    }

    .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
    .particle:nth-child(2) { left: 80%; animation-delay: 0.5s; }
    .particle:nth-child(3) { left: 20%; animation-delay: 1s; }

    @keyframes floatUp {
      0% { transform: translateY(200px) scale(0.5); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(-20px) scale(1); opacity: 0; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .character-speech {
      background: rgba(255,255,255,0.96);
      color: #1a1040;
      padding: 14px 18px;
      border-radius: 20px;
      max-width: 90%;
      position: relative;
      box-shadow: 0 8px 32px rgba(102,126,234,0.25);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .character-speech::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 10px solid rgba(255,255,255,0.96);
    }

    .speech-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.55;
      font-weight: 400;
    }

    .speech-play-btn {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.2s;
      box-shadow: 0 4px 14px rgba(102,126,234,0.4);
    }

    .speech-play-btn:hover { transform: scale(1.1); }
    .speech-play-btn.playing { background: linear-gradient(135deg, #4ade80, #22d3ee); }

    .character-input-area {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 16px;
    }

    .character-voice-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .character-voice-btn:hover {
      background: rgba(255,255,255,0.14);
      transform: scale(1.05);
    }

    .character-voice-btn.recording {
      background: rgba(245,87,108,0.25);
      border-color: rgba(245,87,108,0.45);
      animation: pulseRed 1s infinite;
    }

    @keyframes pulseRed {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245,87,108,0.4); }
      50% { box-shadow: 0 0 0 8px rgba(245,87,108,0); }
    }

    .character-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 24px;
      font-size: 13px;
      color: white;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .character-input::placeholder { color: rgba(255,255,255,0.28); }

    .character-input:focus {
      outline: none;
      border-color: rgba(102,126,234,0.45);
    }

    .character-send-btn {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 24px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      white-space: nowrap;
      box-shadow: 0 4px 16px rgba(102,126,234,0.4);
    }

    .character-send-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 22px rgba(102,126,234,0.6);
    }

    .character-status {
      text-align: center;
      font-size: 12px;
      margin-top: 10px;
      min-height: 18px;
      color: rgba(255,255,255,0.55);
    }

    /* ===== CONTINUATION CARD ===== */
    .continuation-card {
      background: linear-gradient(135deg, rgba(17,153,142,0.12) 0%, rgba(56,239,125,0.08) 100%);
      border: 1px solid rgba(56,239,125,0.18);
      border-radius: 20px;
      padding: 20px;
      margin: 16px 0;
      color: white;
    }

    .continuation-card h3 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .continuation-result {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      line-height: 1.85;
      max-height: 360px;
      overflow-y: auto;
      color: rgba(255,255,255,0.88);
      font-size: 13px;
    }

    /* ===== SCENES SECTION ===== */
    .scenes-section {
      margin: 20px 0;
    }

    .scenes-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-primary);
    }

    .scenes-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .scene-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 16px;
      overflow: hidden;
    }

    .scene-card img {
      width: 100%;
      height: 190px;
      object-fit: cover;
    }

    .scene-card-info {
      padding: 12px;
    }

    .scene-card-info h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .scene-card-info p {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ===== NOVEL CONTENT ===== */
    .novel-content {
      line-height: 1.9;
      color: var(--text-secondary);
      font-size: 13px;
      margin: 16px 0;
      padding: 16px;
      background: rgba(255,255,255,0.025);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      max-height: 280px;
      overflow-y: auto;
    }

    .novel-content p { margin-bottom: 10px; }

    .novel-content h2, .novel-content h3 {
      color: var(--text-primary);
      margin: 14px 0 7px;
    }

    /* ===== PURCHASE FORM ===== */
    .purchase-form {
      background: rgba(102,126,234,0.07);
      border: 1px solid rgba(102,126,234,0.16);
      border-radius: 20px;
      padding: 24px;
      margin-top: 20px;
    }

    .purchase-form h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .form-group { margin-bottom: 14px; }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    input[type="text"],
    input[type="email"],
    select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      font-size: 13px;
      color: white;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    select:focus {
      outline: none;
      border-color: rgba(102,126,234,0.45);
    }

    input::placeholder { color: rgba(255,255,255,0.22); }

    select { cursor: pointer; }
    select option { background: #1a1040; color: white; }

    .price-display {
      text-align: center;
      margin: 20px 0 16px;
    }

    .price-display strong {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #a78bfa, #f093fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .buy-btn {
      background: linear-gradient(135deg, var(--grad-purple) 0%, var(--grad-pink) 60%, var(--grad-coral) 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 4px;
      font-family: inherit;
      transition: all 0.3s;
      box-shadow: 0 8px 32px rgba(102,126,234,0.4);
      letter-spacing: 0.5px;
    }

    .buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(102,126,234,0.6);
    }

    /* ===== VOICE / PLAY BUTTONS ===== */
    .voice-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      width: 50px;
      height: 40px;
      border-radius: 20px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-btn:hover { transform: scale(1.08); }

    .voice-btn.recording {
      background: rgba(245,87,108,0.25);
      border-color: rgba(245,87,108,0.45);
      animation: pulseRed 1s infinite;
    }

    .voice-status {
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      margin-top: 8px;
      min-height: 20px;
    }

    .play-voice-btn {
      background: rgba(255,255,255,0.10);
      border: none;
      padding: 4px 10px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      margin-left: 8px;
      transition: all 0.2s;
      color: white;
    }

    .play-voice-btn:hover { background: rgba(255,255,255,0.18); }
    .play-voice-btn.playing { background: rgba(74,222,128,0.3); }

    /* ===== CHAT INTERFACE ===== */
    .chat-container {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 16px;
      height: 290px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-messages::-webkit-scrollbar { width: 3px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
    }

    .chat-message {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-message.user { flex-direction: row-reverse; }

    .chat-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      flex-shrink: 0;
    }

    .chat-message.user .chat-avatar {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
    }

    .chat-message.assistant .chat-avatar {
      background: linear-gradient(135deg, #f093fb, #f5576c);
    }

    .chat-bubble {
      max-width: 72%;
      padding: 9px 14px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.5;
    }

    .chat-message.user .chat-bubble {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant .chat-bubble {
      background: rgba(255,255,255,0.07);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.09);
      border-bottom-left-radius: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      background: rgba(0,0,0,0.15);
    }

    .chat-input {
      flex: 1;
      padding: 9px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      font-size: 13px;
      color: white;
      font-family: inherit;
    }

    .chat-input::placeholder { color: rgba(255,255,255,0.28); }

    .chat-input:focus {
      outline: none;
      border-color: rgba(102,126,234,0.4);
    }

    .chat-send {
      background: linear-gradient(135deg, var(--grad-purple), var(--grad-pink));
      color: white;
      border: none;
      padding: 9px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      font-family: inherit;
      box-shadow: 0 4px 14px rgba(102,126,234,0.3);
    }

    .chat-send:disabled { opacity: 0.45; cursor: not-allowed; }

    /* ===== DIVIDER ===== */
    .section-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      margin: 24px 0;
    }

    /* ===== SCROLLBARS ===== */
    .modal-content::-webkit-scrollbar { width: 4px; }
    .modal-content::-webkit-scrollbar-track { background: transparent; }
    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
    }

    .novel-content::-webkit-scrollbar { width: 4px; }
    .novel-content::-webkit-scrollbar-track { background: transparent; }
    .novel-content::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
    }

    .continuation-result::-webkit-scrollbar { width: 4px; }
    .continuation-result::-webkit-scrollbar-track { background: transparent; }
    .continuation-result::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .hero { padding: 48px 0 32px; }
      .hero-stats { gap: 20px; }
      .novels-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; }
      .modal-content { padding: 20px; border-radius: 20px; }
      .modal-novel-info { flex-direction: column; }
      .modal-cover, .modal-cover-placeholder { width: 100%; height: 180px; }
      .interactive-section { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
      .hero-title { font-size: 26px; letter-spacing: -0.5px; }
      .brand-name { font-size: 17px; }
      .container { padding: 0 16px; }
    }

    /* ===== FOOTER ===== */
    footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      position: relative;
      z-index: 1;
    }

    footer span {
      background: linear-gradient(90deg, var(--grad-purple), var(--grad-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <header>
    <div class="container">
      <div class="header-inner">
        <div class="header-brand">
          <div class="brand-icon">üìö</div>
          <div>
            <div class="brand-name">NovelGen</div>
            <div class="brand-tagline">AI ¬∑ Â∞èËØ¥ ¬∑ ÂÆáÂÆô</div>
          </div>
        </div>
        <div class="header-right">
          <div class="live-badge">
            <div class="live-dot"></div>
            AI Âú®Á∫ø
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <div class="hero-eyebrow">‚ú® AI ÁîüÊàê ¬∑ ÂÆûÊó∂ÂØπËØù ¬∑ ËßíËâ≤ÊâÆÊºî</div>
      <h1 class="hero-title">
        Êé¢Á¥¢Êó†Èôê<br><span class="gradient-text">Â∞èËØ¥ÂÆáÂÆô</span>
      </h1>
      <p class="hero-subtitle">AI Âàõ‰ΩúÁöÑ‰∏≠ÊñáÁΩëÊñáÔºåÁ≤æÂΩ©ÂâßÊÉÖ‰∏ÄËß¶Âç≥Âèë„ÄÇ<br>Âíå‰Ω†ÊúÄÁà±ÁöÑËßíËâ≤ÂÆûÊó∂ËÅäÂ§©ÔºåËøòËÉΩÁîüÊàê‰∏ìÂ±ûÂú∫ÊôØÂõæ„ÄÇ</p>
    </div>
  </section>

  <div class="container">
    <div class="section-label">ÂÖ®ÈÉ®Â∞èËØ¥</div>
    <div id="novels-container">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p style="color: var(--text-secondary); margin-top: 4px;">Ê≠£Âú®Âä†ËΩΩÂ∞èËØ¥ÂÆáÂÆô...</p>
      </div>
    </div>
  </div>

  <footer>
    Áî± <span>NovelGen AI</span> È©±Âä® ¬∑ AI Âàõ‰ΩúÁöÑ‰∏≠ÊñáÊïÖ‰∫ã‰∏ñÁïå
  </footer>

  <!-- Novel Detail Modal -->
  <div id="novel-modal" class="modal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title"></h2>
        <button class="close-btn" onclick="closeModal()">‚úï</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script type="module">
    // Import Sanity client from CDN
    import { createClient } from 'https://esm.sh/@sanity/client@6'

    // Initialize Sanity client
    const client = createClient({
      projectId: '9cp0f5xw', // Replace with your Sanity project ID
      dataset: 'production', // Replace with your dataset name
      useCdn: true,
      apiVersion: '2024-01-01',
      // If you encounter CORS issues, you can add a token (need to create a read token in Sanity console first)
      // token: 'your-read-token-here'
    })

    // Add debug info
    console.log('Sanity client initialized:', {
      projectId: '9cp0f5xw',
      dataset: 'production',
      currentUrl: window.location.href
    })

    // API URL - Update to actual API address when deploying
    const API_BASE_URL = window.location.origin.includes('localhost')
      ? 'http://localhost:3000'
      : window.location.origin

    // Fetch and display novels
    async function loadNovels() {
      try {
        console.log('Starting to load novels...')
        const novels = await client.fetch(`
          *[_type == "novel"] | order(_createdAt desc) {
            _id,
            title,
            slug,
            coverImage,
            description,
            price,
            currency,
            genre,
            author,
            wordCount,
            "coverUrl": coverImage.asset->url
          }
        `)
        console.log('Novels fetched:', novels)

        const container = document.getElementById('novels-container')

        if (novels.length === 0) {
          container.innerHTML = `<div class="empty-state">
            <h2>ÊöÇÊó†Â∞èËØ¥</h2>
            <p style="color: var(--text-secondary);">ËØ∑ÂÖàÂú® Sanity Studio ‰∏≠ÂàõÂª∫Âπ∂ÂèëÂ∏ÉÂ∞èËØ¥</p>
          </div>`
          return
        }

        // Update novel count in hero
        const novelCount = document.querySelector('.hero-stat-num')

        container.className = 'novels-grid'
        container.innerHTML = novels.map(novel => `
          <div class="novel-card" onclick="showNovelDetail('${novel._id}')">
            <div class="novel-cover-wrapper">
              ${novel.coverUrl
                ? `<img src="${novel.coverUrl}" alt="${novel.title}" class="novel-cover" onerror="this.parentElement.innerHTML='<div class=\\'novel-cover-fallback\\'>üìñ</div><div class=\\'novel-cover-overlay\\'></div>'">`
                : `<div class="novel-cover-fallback">üìñ</div>`}
              <div class="novel-cover-overlay"></div>
              ${novel.genre ? `<div class="novel-genre-badge">${novel.genre}</div>` : ''}
            </div>
            <div class="novel-info">
              <div class="novel-title">${novel.title || 'Êó†Ê†áÈ¢ò'}</div>
              <div class="novel-author">${novel.author ? `by ${novel.author}` : ''}</div>
              <div class="novel-footer">
                <div class="novel-price">${getCurrencySymbol(novel.currency)}${novel.price || 0}</div>
                <button class="novel-cta">ÈòÖËØªËØ¶ÊÉÖ</button>
              </div>
            </div>
          </div>
        `).join('')
      } catch (error) {
        console.error('Error loading novels:', error)
        const container = document.getElementById('novels-container')
        container.className = ''

        const isCorsError = error.message?.includes('CORS') ||
                          error.message?.includes('Failed to fetch') ||
                          error.message?.includes('NetworkError')

        container.innerHTML = `
          <div class="empty-state">
            <h2>Âä†ËΩΩÂ§±Ë¥•</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Error: ${error.message || 'Êú™Áü•ÈîôËØØ'}</p>
            ${isCorsError ? `
              <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.25); padding: 16px; border-radius: 14px; margin: 14px 0; text-align: left;">
                <h3 style="margin: 0 0 10px; color: #fbbf24; font-size: 14px;">‚ö†Ô∏è ÈúÄË¶ÅÈÖçÁΩÆ CORS</h3>
                <p style="margin: 0; color: rgba(251,191,36,0.8); font-size: 13px; line-height: 1.7;">
                  1. ËÆøÈóÆ <a href="https://www.sanity.io/manage" target="_blank" style="color: #fbbf24;">sanity.io/manage</a><br>
                  2. ÈÄâÊã©È°πÁõÆ <strong>9cp0f5xw</strong><br>
                  3. API ‚Üí CORS origins ‚Üí Ê∑ªÂä† <strong>${window.location.origin}</strong><br>
                  4. ÂãæÈÄâ Allow credentials ‚Üí ‰øùÂ≠ò ‚Üí Âà∑Êñ∞È°µÈù¢
                </p>
              </div>
            ` : ''}
            <button onclick="location.reload()" style="margin-top: 12px; padding: 12px 28px; background: linear-gradient(135deg, #667eea, #f093fb); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; font-family: inherit;">
              ÈáçÊñ∞Âä†ËΩΩ
            </button>
          </div>
        `
      }
    }

    // Show novel detail
    async function showNovelDetail(novelId) {
      try {
        const novel = await client.fetch(`
          *[_type == "novel" && _id == $id][0] {
            _id,
            title,
            slug,
            coverImage,
            description,
            content,
            price,
            currency,
            genre,
            author,
            scenes,
            "coverUrl": coverImage.asset->url
          }
        `, { id: novelId })

        if (!novel) {
          alert('Â∞èËØ¥Êú™ÊâæÂà∞')
          return
        }

        document.getElementById('modal-title').textContent = novel.title || 'Êó†Ê†áÈ¢ò'

        const modalBody = document.getElementById('modal-body')
        modalBody.innerHTML = `
          <!-- Novel Info Block -->
          <div class="modal-novel-info">
            ${novel.coverUrl
              ? `<img src="${novel.coverUrl}" alt="${novel.title}" class="modal-cover">`
              : `<div class="modal-cover-placeholder">üìñ</div>`}
            <div class="modal-novel-details">
              <div style="font-size: 18px; font-weight: 800; color: white; margin-bottom: 6px;">${novel.title || 'Êó†Ê†áÈ¢ò'}</div>
              <div class="modal-novel-meta">
                ${novel.author ? `<span class="meta-chip">‚úçÔ∏è ${novel.author}</span>` : ''}
                ${novel.genre ? `<span class="meta-chip genre">${novel.genre}</span>` : ''}
                ${novel.price ? `<span class="meta-chip">üí∞ ${getCurrencySymbol(novel.currency)}${novel.price}</span>` : ''}
              </div>
              ${novel.description ? `<p class="modal-description">${novel.description}</p>` : ''}
            </div>
          </div>

          <!-- Interactive Features -->
          <div class="interactive-section">
            <!-- Image Generation -->
            <div class="feature-card">
              <h3>üé® AI ÁªòÂõæ</h3>
              <p style="font-size: 11px; margin-bottom: 10px; color: rgba(255,255,255,0.65);">Ê†πÊçÆÂ∞èËØ¥ÂÜÖÂÆπÁîüÊàê‰∏ìÂ±ûÂõæÁâá</p>

              <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                <button class="img-type-btn active" data-novel="${novel._id}" data-type="heroine" onclick="selectImageType('${novel._id}', 'heroine', this)">üë© Â•≥‰∏ª</button>
                <button class="img-type-btn" data-novel="${novel._id}" data-type="hero" onclick="selectImageType('${novel._id}', 'hero', this)">üë® Áî∑‰∏ª</button>
                <button class="img-type-btn" data-novel="${novel._id}" data-type="scene" onclick="selectImageType('${novel._id}', 'scene', this)">üé¨ ÂêçÂú∫Èù¢</button>
                <button class="img-type-btn" data-novel="${novel._id}" data-type="couple" onclick="selectImageType('${novel._id}', 'couple', this)">üíë CPÂêåÊ°Ü</button>
                <button class="img-type-btn" data-novel="${novel._id}" data-type="villain" onclick="selectImageType('${novel._id}', 'villain', this)">üòà ÂèçÊ¥æ</button>
                <button class="img-type-btn" data-novel="${novel._id}" data-type="custom" onclick="selectImageType('${novel._id}', 'custom', this)">‚úèÔ∏è Ëá™ÂÆö‰πâ</button>
              </div>

              <input type="hidden" id="img-type-${novel._id}" value="heroine" />

              <input
                type="text"
                id="scene-prompt-${novel._id}"
                class="feature-input"
                placeholder="Ë°•ÂÖÖÊèèËø∞ÔºàÂèØÈÄâÔºâÔºåÂ¶ÇÔºöÁ©øÁ∫¢Ëâ≤ÊôöÁ§ºÊúç„ÄÅÈú∏Ê∞î‰æßÊºè..."
              />
              <button
                class="feature-btn"
                onclick="generateSceneImage('${novel._id}', '${novel.title}', '${novel.genre}')"
                id="gen-img-btn-${novel._id}"
              >
                ‚ú® ÁîüÊàêÂõæÁâá
              </button>
              <div id="generated-image-${novel._id}" class="generated-image-container"></div>
            </div>

          </div>

          <!-- Character Chat Section -->
          <div class="character-chat-section" id="character-chat-${novel._id}">
            <h3>üéôÔ∏è ÂíåËßíËâ≤ÂØπËØù</h3>

            <div class="role-selection" id="role-selection-${novel._id}">
              <button class="role-btn active" data-role="heroine" data-novel="${novel._id}" onclick="selectChatRole('${novel._id}', 'heroine', this)">
                <span class="role-icon">üë©</span>
                <span class="role-name">Â•≥‰∏ª</span>
              </button>
              <button class="role-btn" data-role="hero" data-novel="${novel._id}" onclick="selectChatRole('${novel._id}', 'hero', this)">
                <span class="role-icon">üë®</span>
                <span class="role-name">Áî∑‰∏ª</span>
              </button>
              <button class="role-btn" data-role="villain" data-novel="${novel._id}" onclick="selectChatRole('${novel._id}', 'villain', this)">
                <span class="role-icon">üòà</span>
                <span class="role-name">ÂèçÊ¥æ</span>
              </button>
              <button class="role-btn" data-role="supporting" data-novel="${novel._id}" onclick="selectChatRole('${novel._id}', 'supporting', this)">
                <span class="role-icon">üßë</span>
                <span class="role-name">ÈÖçËßí</span>
              </button>
            </div>
            <input type="hidden" id="chat-role-${novel._id}" value="heroine" />

            <div class="character-stage">
              <div class="character-container" id="character-container-${novel._id}">
                <div class="character-wrapper" id="character-wrapper-${novel._id}">
                  <img
                    src="https://api.dicebear.com/7.x/lorelei/svg?seed=${novel._id}&backgroundColor=ffdfbf"
                    alt="ËßíËâ≤"
                    class="character-image"
                    id="character-image-${novel._id}"
                  />
                  <div class="character-eyes">
                    <div class="character-eye"></div>
                    <div class="character-eye"></div>
                  </div>
                  <div class="character-mouth"></div>
                  <div class="emotion-particles">
                    <span class="particle">‚ú®</span>
                    <span class="particle">üíï</span>
                    <span class="particle">üå∏</span>
                  </div>
                  <div class="sound-waves">
                    <div class="sound-wave"></div>
                    <div class="sound-wave"></div>
                    <div class="sound-wave"></div>
                    <div class="sound-wave"></div>
                    <div class="sound-wave"></div>
                  </div>
                </div>
                <div class="character-speaking-indicator" id="speaking-indicator-${novel._id}"></div>
              </div>

              <div class="character-speech" id="character-speech-${novel._id}">
                <div class="speech-text" id="speech-text-${novel._id}">Âó®ÔΩûÁÇπÂáª‰∏ãÈù¢ÁöÑÈ∫¶ÂÖãÈ£éÂíåÊàëËÅäÂ§©ÂêßÔΩû üòä</div>
                <button class="speech-play-btn" id="speech-play-${novel._id}" onclick="playCurrentSpeech('${novel._id}')">üîä</button>
              </div>
            </div>

            <div class="character-input-area">
              <button
                class="character-voice-btn"
                onclick="startCharacterChat('${novel._id}', '${novel.title}', '${novel.genre}')"
                id="char-voice-btn-${novel._id}"
              >
                üé§
              </button>
              <input
                type="text"
                class="character-input"
                id="char-input-${novel._id}"
                placeholder="ËæìÂÖ•Ê∂àÊÅØÊàñÁÇπÂáªÈ∫¶ÂÖãÈ£éËØ¥ËØù..."
                onkeypress="if(event.key==='Enter')sendCharacterChat('${novel._id}', '${novel.title}', '${novel.genre}')"
              />
              <button
                class="character-send-btn"
                onclick="sendCharacterChat('${novel._id}', '${novel.title}', '${novel.genre}')"
                id="char-send-${novel._id}"
              >
                ÂèëÈÄÅ
              </button>
            </div>
            <div id="char-status-${novel._id}" class="character-status"></div>
          </div>

          <!-- Novel Continuation -->
          <div class="continuation-card">
            <h3>‚úçÔ∏è AI Áª≠ÂÜôÂ∞èËØ¥</h3>
            <p style="font-size: 11px; margin-bottom: 12px; color: rgba(255,255,255,0.6);">ÂëäËØâ AI ‰Ω†ÊÉ≥Áúã‰ªÄ‰πàÂâßÊÉÖÂèëÂ±ï</p>
            <textarea
              id="continue-prompt-${novel._id}"
              class="feature-input"
              style="min-height: 80px; resize: vertical;"
              placeholder="ËæìÂÖ•‰Ω†ÊÉ≥Ë¶ÅÁöÑÂâßÊÉÖÔºå‰æãÂ¶ÇÔºö&#10;‚Ä¢ Â•≥‰∏ªÂèëÁé∞Ê∏£Áî∑Âá∫ËΩ®ËØÅÊçÆÔºåÂΩìÂú∫ÊâìËÑ∏&#10;‚Ä¢ Â•≥‰∏ªÂú®ÂÖ¨Âè∏‰ºöËÆÆ‰∏äÈÄÜË¢≠ÔºåËÆ©ÊâÄÊúâ‰∫∫ÂàÆÁõÆÁõ∏Áúã&#10;‚Ä¢ Áî∑‰∫åÊ∑±ÊÉÖÂëäÁôΩÔºåÂ•≥‰∏ªÁäπË±´..."
            ></textarea>
            <button
              class="feature-btn"
              style="background: rgba(255,255,255,0.9); color: #11998e;"
              onclick="continueNovel('${novel._id}', '${novel.title}', '${novel.genre}')"
              id="continue-btn-${novel._id}"
            >
              üìù ÁîüÊàêÂâßÊÉÖ
            </button>
            <div id="continuation-result-${novel._id}" class="continuation-result" style="display: none;">
              <h4 style="margin: 0 0 10px; color: rgba(255,255,255,0.9); font-size: 13px;">üìñ Êñ∞ÂâßÊÉÖÔºö</h4>
              <div id="continuation-text-${novel._id}"></div>
            </div>
          </div>

          ${novel.scenes && novel.scenes.length > 0 ? `
            <div class="scenes-section">
              <div class="scenes-title">üé® AI ÁîüÊàêÂú∫ÊôØÂõæ</div>
              <div class="scenes-grid">
                ${novel.scenes.filter(s => s.status === 'completed' && s.imageUrl).map(scene => `
                  <div class="scene-card">
                    <img
                      src="${scene.imageUrl}"
                      alt="${scene.title || 'Scene'}"
                      onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Available'"
                    />
                    <div class="scene-card-info">
                      <h4>${scene.title || 'Âú∫ÊôØ'}</h4>
                      ${scene.description ? `<p>${scene.description.substring(0, 80)}...</p>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="novel-content" id="novel-content"></div>

          <div class="purchase-form">
            <h3>Á´ãÂç≥Ë¥≠‰π∞</h3>
            <form id="purchase-form" onsubmit="handlePurchase(event, '${novel._id}', ${novel.price}, '${novel.currency}')">
              <div class="form-group">
                <label>ÂßìÂêç *</label>
                <input type="text" name="name" required placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç">
              </div>
              <div class="form-group">
                <label>ÈÇÆÁÆ± *</label>
                <input type="email" name="email" required placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈÇÆÁÆ±">
              </div>
              <div class="form-group">
                <label>ÊîØ‰ªòÊñπÂºè</label>
                <select name="paymentMethod">
                  <option value="credit_card">‰ø°Áî®Âç°</option>
                  <option value="paypal">PayPal</option>
                  <option value="bank_transfer">Èì∂Ë°åËΩ¨Ë¥¶</option>
                </select>
              </div>
              <div class="price-display">
                <strong>${getCurrencySymbol(novel.currency)}${novel.price || 0}</strong>
              </div>
              <button type="submit" class="buy-btn">Á´ãÂç≥Ë¥≠‰π∞</button>
            </form>
          </div>
        `

        // Render novel content
        if (novel.content && novel.content.length > 0) {
          renderContent(novel.content, document.getElementById('novel-content'))
          novelContents[novel._id] = extractTextFromBlocks(novel.content)

          const characters = extractCharacterNames(novel._id, novelContents[novel._id])
          updateRoleButtons(novel._id, characters)

          const speechText = document.getElementById(`speech-text-${novel._id}`)
          if (speechText && characters?.heroine) {
            const greeting = getCharacterGreeting(novel._id, 'heroine')
            speechText.textContent = greeting
            currentSpeechTexts[novel._id] = greeting
          }
        } else {
          document.getElementById('novel-content').innerHTML = '<p style="color: var(--text-muted);">ÊöÇÊó†ÂÜÖÂÆπ</p>'
          novelContents[novel._id] = ''
        }

        document.getElementById('novel-modal').classList.add('active')
      } catch (error) {
        console.error('Error loading novel:', error)
        alert('Âä†ËΩΩÂ∞èËØ¥ËØ¶ÊÉÖÂ§±Ë¥•')
      }
    }

    // Extract plain text from portable text blocks
    function extractTextFromBlocks(blocks) {
      if (!blocks || blocks.length === 0) return ''

      return blocks.map(block => {
        if (block._type === 'block' && block.children) {
          return block.children
            .filter(child => child._type === 'span')
            .map(child => child.text)
            .join('')
        }
        return ''
      }).join('\n')
    }

    // Render Sanity portable text content
    function renderContent(blocks, container) {
      if (!blocks || blocks.length === 0) return

      blocks.forEach(block => {
        if (block._type === 'block') {
          const tag = block.style === 'h1' ? 'h2' : block.style === 'h2' ? 'h3' : 'p'
          const element = document.createElement(tag)

          if (block.children) {
            block.children.forEach(child => {
              if (child._type === 'span') {
                const text = document.createTextNode(child.text)
                element.appendChild(text)
              }
            })
          }

          container.appendChild(element)
        }
      })
    }

    // Handle purchase
    async function handlePurchase(event, novelId, price, currency) {
      event.preventDefault()
      const form = event.target
      const formData = new FormData(form)

      const orderData = {
        _type: 'order',
        novel: {
          _type: 'reference',
          _ref: novelId
        },
        customerName: formData.get('name'),
        customerEmail: formData.get('email'),
        amount: price,
        currency: currency,
        paymentMethod: formData.get('paymentMethod'),
        status: 'pending',
        purchasedAt: new Date().toISOString()
      }

      try {
        alert(`ËÆ¢ÂçïÊèê‰∫§ÊàêÂäüÔºÅ\n\nÂßìÂêçÔºö${orderData.customerName}\nÈÇÆÁÆ±Ôºö${orderData.customerEmail}\nÈáëÈ¢ùÔºö${getCurrencySymbol(currency)}${price}\n\nÊ≥®ÊÑèÔºöËøôÊòØ‰∏Ä‰∏™ÊºîÁ§∫Á§∫‰æã„ÄÇÊ≠£Âºè‰∏äÁ∫øÈúÄË¶ÅÈõÜÊàêÊîØ‰ªòÁ≥ªÁªü„ÄÇ`)
        closeModal()
      } catch (error) {
        console.error('Error creating order:', error)
        alert('ËÆ¢ÂçïÊèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ')
      }
    }

    // Store chat history per novel
    const chatHistories = {}

    // Store novel content for chat context
    const novelContents = {}

    // Store character images by role (heroine, hero, villain, supporting)
    const characterImages = {}

    // Store current speech text for replay
    const currentSpeechTexts = {}

    // Store current chat role
    const currentChatRoles = {}

    // Default avatar URLs for each role
    const defaultAvatars = {
      heroine: (id) => `https://api.dicebear.com/7.x/lorelei/svg?seed=${id}&backgroundColor=ffdfbf`,
      hero: (id) => `https://api.dicebear.com/7.x/lorelei/svg?seed=${id}-hero&backgroundColor=b6e3f4&hair=short01,short02,short03`,
      villain: (id) => `https://api.dicebear.com/7.x/lorelei/svg?seed=${id}-villain&backgroundColor=ffd5dc`,
      supporting: (id) => `https://api.dicebear.com/7.x/lorelei/svg?seed=${id}-support&backgroundColor=d1d4f9`
    }

    // Role display info (default)
    const roleInfo = {
      heroine: { name: 'Â•≥‰∏ª', greeting: 'Âó®ÔΩûÁÇπÂáª‰∏ãÈù¢ÁöÑÈ∫¶ÂÖãÈ£éÂíåÊàëËÅäÂ§©ÂêßÔΩû üòä', voice: 'nova' },
      hero: { name: 'Áî∑‰∏ª', greeting: '‰Ω†Â•ΩÔºåÊúâ‰ªÄ‰πàÊÉ≥ÂíåÊàëËØ¥ÁöÑÂêóÔºü', voice: 'onyx' },
      villain: { name: 'ÂèçÊ¥æ', greeting: 'ÂìºÔºå‰Ω†Êù•ÊâæÊàëÂÅö‰ªÄ‰πàÔºü üòè', voice: 'echo' },
      supporting: { name: 'ÈÖçËßí', greeting: 'ÂïäÔºå‰Ω†ÊÉ≥ÂíåÊàëËÅäËÅäÂêóÔºü', voice: 'alloy' }
    }

    // Store extracted character names per novel
    const novelCharacters = {}

    // Extract character names from novel content
    function extractCharacterNames(novelId, content) {
      if (!content) return null

      const surnameChars = 'ÊûóËãèÂè∂ÈôÜÈ°æÊ≤àÂë®ÁéãÊùéÂº†ÂàòÈôàÊù®ÈªÑËµµÂê¥ÈÉëÂ≠ôËÉ°Êú±È´ò‰ΩïÈÉ≠ÁΩóÂÆãË∞¢ÂîêÈü©ÊõπËÆ∏ÈÇìËêßÁ®ãÊ±üÂÜØÈôàË§öÂç´ËíãËë£È≠èËñõÈõ∑Ë¥∫ÂÄ™Ê±§ÊÆ∑ÁΩóÊØïÈÉùÂÆâÂ∏∏'

      // 1) Count full names (2-3 chars, surname + given name)
      // ÊéíÈô§ Âè∂ÊÄª„ÄÅÊûóÂ∞èÂßê ËøôÁ±ªÁß∞ÂëºÔºåÂè™ÁªüËÆ°ÁúüÊ≠£ÁöÑÂêçÂ≠ó
      const titleSuffixes = ['ÊÄª', 'ÂÖàÁîü', 'Â∞èÂßê', 'Â•≥Â£´', 'Âä©ÁêÜ', 'ÁªèÁêÜ', 'Ëë£‰∫ã', 'ÂæãÂ∏à', 'ÂåªÁîü', 'ËÄÅÂ∏à']
      const namePattern = new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{1,2})`, 'g')
      const nameCount = {}
      let match
      while ((match = namePattern.exec(content)) !== null) {
        const name = match[1]
        // ÊéíÈô§Áß∞ÂëºÔºàÂè∂ÊÄª„ÄÅÊûóÂ∞èÂßêÁ≠âÔºâ
        const isTitle = titleSuffixes.some(suffix => name.endsWith(suffix))
        if (name.length >= 2 && name.length <= 3 && !isTitle) {
          nameCount[name] = (nameCount[name] || 0) + 1
        }
      }

      // 2) Count title forms (Âè∂ÊÄª„ÄÅÊûóÂ∞èÂßê„ÄÅÈôÜÂÖàÁîü) and merge into full name of same Âßì
      const titlePattern = new RegExp(`([${surnameChars}])(ÊÄª|ÂÖàÁîü|Â∞èÂßê|Â•≥Â£´|Âä©ÁêÜ)`, 'g')
      const titleCount = {}
      while ((match = titlePattern.exec(content)) !== null) {
        const key = match[1] + match[2]  // e.g. Âè∂ÊÄª
        titleCount[key] = (titleCount[key] || 0) + 1
      }

      // 3) Merge Âè∂ÊÄª etc. into Âè∂ÊôØÊ∑± (same Âßì, add title count to that full name)
      for (const [titleKey, count] of Object.entries(titleCount)) {
        const surname = titleKey[0]
        const fullNamesWithSurname = Object.keys(nameCount).filter(n => n[0] === surname)
        if (fullNamesWithSurname.length > 0) {
          const mainName = fullNamesWithSurname.sort((a, b) => nameCount[b] - nameCount[a])[0]
          nameCount[mainName] = (nameCount[mainName] || 0) + count
        }
      }

      // 4) Sort by frequency (include names that appear at least once)
      const sortedNames = Object.entries(nameCount)
        .filter(([name, count]) => count >= 1 && name.length >= 2)
        .sort((a, b) => b[1] - a[1])
        .map(([name]) => name)

      const characters = {
        heroine: null,
        hero: null,
        villain: null,
        supporting: null
      }

      const heroinePatterns = [
        new RegExp(`Â•≥‰∏ª[ËßíÊòØÂè´]?[Ôºö:„Äë]?\\s*([${surnameChars}][‰∏Ä-Èæ•]{2})`),
        new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{2}).{0,15}(Â•≥‰∏ª|Áã¨Á´ã|ËÅ™Êòé|ÂùöÂº∫|Á¶ªÂ©ö|ÂçèËÆÆ‰π¶|Á≠æÂ≠ó)`),
        new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{2})Á´ôÂú®|([${surnameChars}][‰∏Ä-Èæ•]{2})Êé®ÂºÄÈó®`)
      ]
      const heroPatterns = [
        new RegExp(`Áî∑‰∏ª[ËßíÊòØÂè´]?[Ôºö:„Äë]?\\s*([${surnameChars}][‰∏Ä-Èæ•]{1,2})`),
        new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{2}).{0,15}(ÊÄªË£Å|Ê∑±ÊÉÖ|Ëã±‰øä|‰∏àÂ§´|Êú™Â©öÂ§´)`),
        new RegExp(`[${surnameChars}]ÊÄª.{0,5}([${surnameChars}][‰∏Ä-Èæ•]{2})`)
      ]
      const villainPatterns = [
        new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{2}).{0,10}(ÂèçÊ¥æ|Èò¥Èô©|Â´âÂ¶í|ÂæóÊÑè|ÁôΩËé≤Ëä±|ÂøÉÊú∫|Èó∫Ëúú|Á†¥Âùè)`),
        new RegExp(`ÈÇ£‰∏™Â•≥‰∫∫.{0,8}([${surnameChars}][‰∏Ä-Èæ•]{2})|Âè¶‰∏Ä‰∏™Â•≥‰∫∫.{0,8}([${surnameChars}][‰∏Ä-Èæ•]{2})`)
      ]
      const supportingPatterns = [
        new RegExp(`Âä©ÁêÜ[Ôºö:„Äë]?\\s*[„Äå"]?([${surnameChars}][‰∏Ä-Èæ•]{2})`),
        new RegExp(`(ÂæãÂ∏à|ÊúãÂèã|Áßò‰π¶|ÊäïËµÑ‰∫∫).{0,8}([${surnameChars}][‰∏Ä-Èæ•]{2})`),
        new RegExp(`([${surnameChars}][‰∏Ä-Èæ•]{2})ÂÜ≤ËøõÊù•|([${surnameChars}][‰∏Ä-Èæ•]{2})ËØ¥ÈÅì`),
        new RegExp(`(?:Ë∫´Ëæπ|Ë∫´ÊóÅ|ÂØπÈù¢).{0,5}([${surnameChars}][‰∏Ä-Èæ•]{2})`)
      ]

      // Heroine
      for (const pattern of heroinePatterns) {
        const m = content.match(pattern)
        const name = m && (m[1] || m[2])
        if (name && name.length >= 2) {
          characters.heroine = name
          break
        }
      }
      if (!characters.heroine && sortedNames.length > 0) characters.heroine = sortedNames[0]

      // Hero (ensure Âè∂ÊÄª -> Âè∂ÊôØÊ∑±: prefer full name that appears with ÊÄª)
      for (const pattern of heroPatterns) {
        const m = content.match(pattern)
        const name = m && (m[1] || m[2])
        if (name && name.length >= 2 && name !== characters.heroine) {
          characters.hero = name
          break
        }
      }
      if (!characters.hero) {
        for (const name of sortedNames) {
          if (name !== characters.heroine) {
            characters.hero = name
            break
          }
        }
      }

      // Villain
      for (const pattern of villainPatterns) {
        const m = content.match(pattern)
        const name = m && (m[1] || m[2])
        if (name && name.length >= 2 && name !== characters.heroine && name !== characters.hero) {
          characters.villain = name
          break
        }
      }
      if (!characters.villain) {
        for (const name of sortedNames) {
          if (name !== characters.heroine && name !== characters.hero) {
            characters.villain = name
            break
          }
        }
      }

      // Supporting
      for (const name of sortedNames) {
        if (name !== characters.heroine && name !== characters.hero && name !== characters.villain) {
          characters.supporting = name
          break
        }
      }
      for (const pattern of supportingPatterns) {
        if (characters.supporting) break
        const m = content.match(pattern)
        const name = m && (m[1] || m[2] || m[3])
        if (name && name.length >= 2 && name !== characters.heroine && name !== characters.hero && name !== characters.villain) {
          characters.supporting = name
          break
        }
      }
      if (!characters.supporting && sortedNames.length >= 4) {
        characters.supporting = sortedNames[3]
      }
      if (!characters.supporting && sortedNames.length >= 3) {
        characters.supporting = sortedNames[2]
      }

      novelCharacters[novelId] = characters
      return characters
    }

    // Update role buttons with actual names
    function updateRoleButtons(novelId, characters) {
      if (!characters) return

      const roleTypes = ['heroine', 'hero', 'villain', 'supporting']
      const defaultNames = { heroine: 'Â•≥‰∏ª', hero: 'Áî∑‰∏ª', villain: 'ÂèçÊ¥æ', supporting: 'ÈÖçËßí' }

      roleTypes.forEach(role => {
        const btn = document.querySelector(`[data-novel="${novelId}"][data-role="${role}"] .role-name`)
        if (btn) {
          const name = characters[role] || defaultNames[role]
          btn.textContent = name
        }
      })
    }

    // Get character greeting
    function getCharacterGreeting(novelId, role) {
      const characters = novelCharacters[novelId]
      const name = characters?.[role]

      const greetings = {
        heroine: name ? `Âó®ÔΩûÊàëÊòØ${name}ÔºåÁÇπÂáªÈ∫¶ÂÖãÈ£éÂíåÊàëËÅäÂ§©ÂêßÔΩû üòä` : 'Âó®ÔΩûÁÇπÂáª‰∏ãÈù¢ÁöÑÈ∫¶ÂÖãÈ£éÂíåÊàëËÅäÂ§©ÂêßÔΩû üòä',
        hero: name ? `ÊàëÊòØ${name}ÔºåÊúâ‰ªÄ‰πà‰∫ãÔºü` : '‰Ω†Â•ΩÔºåÊúâ‰ªÄ‰πàÊÉ≥ÂíåÊàëËØ¥ÁöÑÂêóÔºü',
        villain: name ? `ÂìºÔºåÊàëÊòØ${name}Ôºå‰Ω†Êù•ÊâæÊàëÂÅö‰ªÄ‰πàÔºü üòè` : 'ÂìºÔºå‰Ω†Êù•ÊâæÊàëÂÅö‰ªÄ‰πàÔºü üòè',
        supporting: name ? `ÂïäÔºåÊàëÊòØ${name}Ôºå‰Ω†ÊÉ≥ËÅäËÅäÂêóÔºü` : 'ÂïäÔºå‰Ω†ÊÉ≥ÂíåÊàëËÅäËÅäÂêóÔºü'
      }

      return greetings[role] || greetings.heroine
    }

    // Select chat role
    function selectChatRole(novelId, role, btn) {
      document.getElementById(`chat-role-${novelId}`).value = role
      currentChatRoles[novelId] = role

      document.querySelectorAll(`[data-novel="${novelId}"].role-btn`).forEach(b => {
        b.classList.remove('active')
      })
      btn.classList.add('active')

      const charImg = document.getElementById(`character-image-${novelId}`)
      const imageKey = `${novelId}-${role}`
      if (characterImages[imageKey]) {
        charImg.src = characterImages[imageKey]
      } else {
        charImg.src = defaultAvatars[role](novelId)
      }

      const speechText = document.getElementById(`speech-text-${novelId}`)
      const greeting = getCharacterGreeting(novelId, role)
      speechText.textContent = greeting
      currentSpeechTexts[novelId] = greeting

      if (chatHistories[novelId]) {
        chatHistories[novelId] = []
      }
    }
    window.selectChatRole = selectChatRole

    // Image type selection
    function selectImageType(novelId, type, btn) {
      document.getElementById(`img-type-${novelId}`).value = type

      document.querySelectorAll(`[data-novel="${novelId}"].img-type-btn`).forEach(b => {
        b.classList.remove('active')
      })
      btn.classList.add('active')

      const promptInput = document.getElementById(`scene-prompt-${novelId}`)
      const placeholders = {
        'heroine': 'Ë°•ÂÖÖÊèèËø∞ÔºàÂèØÈÄâÔºâÔºåÂ¶ÇÔºöÁ©øÁ∫¢Ë£ô„ÄÅÈú∏Ê∞î‰æßÊºè„ÄÅÂÜ∑Ëâ≥...',
        'hero': 'Ë°•ÂÖÖÊèèËø∞ÔºàÂèØÈÄâÔºâÔºåÂ¶ÇÔºöÊ∑±ÊÉÖÂáùËßÜ„ÄÅË•øË£ÖÈù©Â±•„ÄÅËÖπÈªë...',
        'scene': 'ÊèèËø∞Âú∫ÊôØÔºåÂ¶ÇÔºöÂ•≥‰∏ªÂΩì‰ºóÊâìËÑ∏ÁôΩËé≤Ëä±„ÄÅÊ∑±Â§úÂëäÁôΩ...',
        'couple': 'Ë°•ÂÖÖÊèèËø∞ÔºàÂèØÈÄâÔºâÔºåÂ¶ÇÔºöÈõ®‰∏≠Áõ∏Êã•„ÄÅÂ©öÁ§ºÁé∞Âú∫...',
        'villain': 'Ë°•ÂÖÖÊèèËø∞ÔºàÂèØÈÄâÔºâÔºåÂ¶ÇÔºöÈò¥Èô©Áã°ËØà„ÄÅÂÅáË£ÖÊó†Ëæú...',
        'custom': 'ËæìÂÖ•‰Ω†ÊÉ≥Ë¶ÅÁöÑ‰ªª‰ΩïÁîªÈù¢ÊèèËø∞...'
      }
      promptInput.placeholder = placeholders[type] || 'ËæìÂÖ•ÊèèËø∞...'
    }

    window.selectImageType = selectImageType

    // Generate Image
    async function generateSceneImage(novelId, novelTitle, genre) {
      const promptInput = document.getElementById(`scene-prompt-${novelId}`)
      const imgTypeInput = document.getElementById(`img-type-${novelId}`)
      const btn = document.getElementById(`gen-img-btn-${novelId}`)
      const container = document.getElementById(`generated-image-${novelId}`)

      const userPrompt = promptInput.value.trim()
      const imageType = imgTypeInput ? imgTypeInput.value : 'heroine'

      if (imageType === 'custom' && !userPrompt) {
        alert('Ëá™ÂÆö‰πâÁ±ªÂûãËØ∑ËæìÂÖ•ÊèèËø∞')
        return
      }

      btn.disabled = true
      btn.textContent = '‚è≥ ÁîüÊàê‰∏≠...'
      container.innerHTML = '<p style="color: rgba(255,255,255,0.6); font-size: 13px; text-align: center; padding: 12px;">Ê≠£Âú®ÁîüÊàêÂõæÁâáÔºåËØ∑Á®çÂÄô...</p>'

      try {
        const novelContent = novelContents[novelId] || ''

        const typePrompts = {
          'heroine': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁöÑÂ•≥‰∏ªËßí‰∫∫Áâ©Á´ãÁªò„ÄÇ\nÂ•≥‰∏ªÁâπÁÇπÔºöËÅ™ÊòéÁã¨Á´ã„ÄÅÁæé‰∏ΩËá™‰ø°„ÄÅÊ∞îÂú∫Âº∫Â§ßÁöÑÂ§ßÂ•≥‰∏ª„ÄÇ`,
          'hero': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁöÑÁî∑‰∏ªËßí‰∫∫Áâ©Á´ãÁªò„ÄÇ\nÁî∑‰∏ªÁâπÁÇπÔºöÂ∏ÖÊ∞îÂ§öÈáë„ÄÅÊ∑±ÊÉÖ‰∏ì‰∏Ä„ÄÅË¢´Â•≥‰∏ªÂê∏ÂºïÁöÑ‰ºòË¥®Áî∑ÊÄß„ÄÇ`,
          'scene': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁöÑÁ≤æÂΩ©ÂêçÂú∫Èù¢„ÄÇ`,
          'couple': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁöÑÁî∑Â•≥‰∏ªÂêåÊ°ÜÁîªÈù¢„ÄÇ\nCPÊÑüÔºöÁîúËúú„ÄÅÊ∑±ÊÉÖ„ÄÅÂäøÂùáÂäõÊïåÁöÑÁà±ÊÉÖ„ÄÇ`,
          'villain': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁöÑÂèçÊ¥æËßíËâ≤„ÄÇ\nÁâπÁÇπÔºöË°®Èù¢ÂñÑËâØÂÆûÂàôÈò¥Èô©„ÄÅÁªøËå∂/ÁôΩËé≤Ëä±„ÄÅÊúÄÂêéË¢´ÊâìËÑ∏ÁöÑËßíËâ≤„ÄÇ`,
          'custom': `Â∞èËØ¥„Ää${novelTitle}„ÄãÁõ∏ÂÖ≥ÂõæÁâá„ÄÇ`
        }

        let fullPrompt = typePrompts[imageType] || typePrompts['custom']
        fullPrompt += '\n\n'

        if (novelContent) {
          fullPrompt += `Â∞èËØ¥ËÉåÊôØÔºö${novelContent.substring(0, 400)}\n\n`
        }

        if (userPrompt) {
          fullPrompt += `È¢ùÂ§ñË¶ÅÊ±ÇÔºö${userPrompt}\n\n`
        }

        fullPrompt += `È£éÊ†ºË¶ÅÊ±ÇÔºö${genre || 'Â§ßÂ•≥‰∏ª'}È£éÊ†ºÔºåÈ´òË¥®ÈáèÊèíÁîªÔºåÁ≤æÁæé‰∫∫Áâ©ÔºåÁîµÂΩ±ÊÑüÂÖâÂΩ±Ôºå${imageType === 'scene' ? 'Âú∫ÊôØÂÆèÂ§ßÔºåÊ∞õÂõ¥ÊÑüÂº∫' : '‰∫∫Áâ©ÁæéÂûãÔºå‰∫îÂÆòÁ≤æËá¥'}Ôºå‰∏≠ÂõΩÈ£é/Áé∞‰ª£ÈÉΩÂ∏ÇÈ£éÊ†º„ÄÇ`

        const response = await fetch(`${API_BASE_URL}/api/generate-image`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: fullPrompt,
            sceneTitle: userPrompt.substring(0, 30) || imageType,
            novelTitle,
            genre
          }),
        })

        if (!response.ok) {
          const error = await response.json()
          throw new Error(error.error || 'Failed to generate image')
        }

        const data = await response.json()

        let imageUrl = null
        if (data.imageUrl) {
          imageUrl = data.imageUrl
          container.innerHTML = `
            <img src="${data.imageUrl}" alt="Generated scene" class="generated-image" />
            <p style="color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 8px; text-align: center;">‚ú® ÁîüÊàêÊàêÂäü</p>
          `
        } else if (data.imageData) {
          imageUrl = `data:${data.mimeType};base64,${data.imageData}`
          container.innerHTML = `
            <img src="${imageUrl}" alt="Generated scene" class="generated-image" />
            <p style="color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 8px; text-align: center;">‚ú® ÁîüÊàêÊàêÂäü</p>
          `
        } else {
          throw new Error('No image in response')
        }

        const roleTypes = ['heroine', 'hero', 'villain']
        if (roleTypes.includes(imageType) && imageUrl) {
          const imageKey = `${novelId}-${imageType}`
          characterImages[imageKey] = imageUrl

          const currentRole = currentChatRoles[novelId] || 'heroine'
          if (imageType === currentRole) {
            const charImg = document.getElementById(`character-image-${novelId}`)
            if (charImg) {
              charImg.src = imageUrl
              charImg.style.borderRadius = '16px'
            }
          }
        }

        promptInput.value = ''
      } catch (error) {
        console.error('Image generation error:', error)
        container.innerHTML = `<p style="color: rgba(245,87,108,0.8); font-size: 12px; text-align: center;">‚ùå ÁîüÊàêÂ§±Ë¥•: ${error.message}</p>`
      } finally {
        btn.disabled = false
        btn.textContent = '‚ú® ÁîüÊàêÂõæÁâá'
      }
    }

    // Chat with Protagonist
    async function sendChat(novelId, novelTitle, genre) {
      const input = document.getElementById(`chat-input-${novelId}`)
      const btn = document.getElementById(`chat-send-${novelId}`)
      const messagesContainer = document.getElementById(`chat-messages-${novelId}`)

      const message = input.value.trim()
      if (!message) return

      if (!chatHistories[novelId]) {
        chatHistories[novelId] = []
      }

      messagesContainer.innerHTML += `
        <div class="chat-message user">
          <div class="chat-avatar">üôã</div>
          <div class="chat-bubble">${message}</div>
        </div>
      `

      chatHistories[novelId].push({ role: 'user', content: message })

      input.value = ''
      btn.disabled = true
      messagesContainer.scrollTop = messagesContainer.scrollHeight

      const typingId = `typing-${Date.now()}`
      messagesContainer.innerHTML += `
        <div class="chat-message assistant" id="${typingId}">
          <div class="chat-avatar">üë©</div>
          <div class="chat-bubble">Ê≠£Âú®ËæìÂÖ•...</div>
        </div>
      `
      messagesContainer.scrollTop = messagesContainer.scrollHeight

      try {
        const response = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            novelTitle,
            genre,
            novelContent: novelContents[novelId] || '',
            chatHistory: chatHistories[novelId]
          }),
        })

        document.getElementById(typingId)?.remove()

        if (!response.ok) {
          const error = await response.json()
          throw new Error(error.error || 'Chat failed')
        }

        const data = await response.json()

        messagesContainer.innerHTML += `
          <div class="chat-message assistant">
            <div class="chat-avatar">üë©</div>
            <div class="chat-bubble">${data.reply}</div>
          </div>
        `

        chatHistories[novelId].push({ role: 'assistant', content: data.reply })

      } catch (error) {
        console.error('Chat error:', error)
        document.getElementById(typingId)?.remove()
        messagesContainer.innerHTML += `
          <div class="chat-message assistant">
            <div class="chat-avatar">üë©</div>
            <div class="chat-bubble">Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ§ç...ËØ∑Á®çÂêéÂÜçËØï üíî</div>
          </div>
        `
      } finally {
        btn.disabled = false
        messagesContainer.scrollTop = messagesContainer.scrollHeight
      }
    }

    // Voice Chat Functions
    let currentRecognition = null
    let currentAudio = null

    // Start voice input
    function startVoiceInput(novelId, novelTitle, genre) {
      const btn = document.getElementById(`voice-btn-${novelId}`)
      const status = document.getElementById(`voice-status-${novelId}`)

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
      if (!SpeechRecognition) {
        status.textContent = '‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÔºåËØ∑‰ΩøÁî® Chrome'
        return
      }

      if (currentRecognition) {
        currentRecognition.stop()
        return
      }

      const recognition = new SpeechRecognition()
      recognition.lang = 'zh-CN'
      recognition.continuous = false
      recognition.interimResults = true

      recognition.onstart = () => {
        btn.classList.add('recording')
        btn.textContent = '‚èπÔ∏è'
        status.textContent = 'üé§ Ê≠£Âú®Âê¨...'
      }

      recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('')

        document.getElementById(`chat-input-${novelId}`).value = transcript
        status.textContent = `üìù ${transcript}`
      }

      recognition.onend = () => {
        btn.classList.remove('recording')
        btn.textContent = 'üé§'
        currentRecognition = null

        const input = document.getElementById(`chat-input-${novelId}`)
        if (input.value.trim()) {
          status.textContent = '‚úÖ ËØÜÂà´ÂÆåÊàêÔºåÂèëÈÄÅ‰∏≠...'
          sendVoiceChat(novelId, novelTitle, genre)
        } else {
          status.textContent = ''
        }
      }

      recognition.onerror = (event) => {
        btn.classList.remove('recording')
        btn.textContent = 'üé§'
        status.textContent = `‚ùå ËØÜÂà´Â§±Ë¥•: ${event.error}`
        currentRecognition = null
      }

      currentRecognition = recognition
      recognition.start()
    }

    // Send voice chat (with TTS response)
    async function sendVoiceChat(novelId, novelTitle, genre) {
      const input = document.getElementById(`chat-input-${novelId}`)
      const btn = document.getElementById(`chat-send-${novelId}`)
      const voiceBtn = document.getElementById(`voice-btn-${novelId}`)
      const messagesContainer = document.getElementById(`chat-messages-${novelId}`)
      const status = document.getElementById(`voice-status-${novelId}`)

      const message = input.value.trim()
      if (!message) return

      if (!chatHistories[novelId]) {
        chatHistories[novelId] = []
      }

      messagesContainer.innerHTML += `
        <div class="chat-message user">
          <div class="chat-avatar">üôã</div>
          <div class="chat-bubble">${message}</div>
        </div>
      `

      chatHistories[novelId].push({ role: 'user', content: message })
      input.value = ''
      btn.disabled = true
      voiceBtn.disabled = true
      messagesContainer.scrollTop = messagesContainer.scrollHeight

      const typingId = `typing-${Date.now()}`
      messagesContainer.innerHTML += `
        <div class="chat-message assistant" id="${typingId}">
          <div class="chat-avatar">üë©</div>
          <div class="chat-bubble">Ê≠£Âú®ÊÄùËÄÉ...</div>
        </div>
      `
      messagesContainer.scrollTop = messagesContainer.scrollHeight

      try {
        const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            novelTitle,
            genre,
            novelContent: novelContents[novelId] || '',
            chatHistory: chatHistories[novelId]
          }),
        })

        document.getElementById(typingId)?.remove()

        if (!chatResponse.ok) {
          throw new Error('Chat failed')
        }

        const chatData = await chatResponse.json()
        const reply = chatData.reply

        const replyId = `reply-${Date.now()}`
        messagesContainer.innerHTML += `
          <div class="chat-message assistant">
            <div class="chat-avatar">üë©</div>
            <div class="chat-bubble">${reply}</div>
            <button class="play-voice-btn" id="play-${replyId}" onclick="playVoice('${replyId}', \`${reply.replace(/`/g, "'").replace(/\\/g, "\\\\")}\`)">üîä</button>
          </div>
        `

        chatHistories[novelId].push({ role: 'assistant', content: reply })
        messagesContainer.scrollTop = messagesContainer.scrollHeight

        status.textContent = 'üîä Ê≠£Âú®ÁîüÊàêËØ≠Èü≥...'
        await playVoice(replyId, reply)
        status.textContent = ''

      } catch (error) {
        console.error('Voice chat error:', error)
        document.getElementById(typingId)?.remove()
        messagesContainer.innerHTML += `
          <div class="chat-message assistant">
            <div class="chat-avatar">üë©</div>
            <div class="chat-bubble">Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ§ç... üíî</div>
          </div>
        `
        status.textContent = ''
      } finally {
        btn.disabled = false
        voiceBtn.disabled = false
        messagesContainer.scrollTop = messagesContainer.scrollHeight
      }
    }

    // Play voice (TTS)
    async function playVoice(replyId, text) {
      const playBtn = document.getElementById(`play-${replyId}`)

      if (currentAudio) {
        currentAudio.pause()
        currentAudio = null
        document.querySelectorAll('.play-voice-btn').forEach(b => {
          b.classList.remove('playing')
          b.textContent = 'üîä'
        })
      }

      if (playBtn) {
        playBtn.classList.add('playing')
        playBtn.textContent = '‚è≥'
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/tts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, voice: 'nova' }),
        })

        if (!response.ok) {
          throw new Error('TTS failed')
        }

        const data = await response.json()

        if (data.audio) {
          const audio = new Audio(`data:${data.mimeType};base64,${data.audio}`)
          currentAudio = audio

          if (playBtn) {
            playBtn.textContent = '‚è∏Ô∏è'
          }

          audio.onended = () => {
            if (playBtn) {
              playBtn.classList.remove('playing')
              playBtn.textContent = 'üîä'
            }
            currentAudio = null
          }

          await audio.play()
        }
      } catch (error) {
        console.error('TTS error:', error)
        if (playBtn) {
          playBtn.classList.remove('playing')
          playBtn.textContent = 'üîä'
        }
      }
    }

    // Play welcome voice
    async function playWelcomeVoice(novelId) {
      const welcomeText = 'Âó®ÔΩûÊàëÊòØËøô‰∏™ÊïÖ‰∫ãÁöÑÂ•≥‰∏ªËßíÔºÅÁÇπÂáªÈ∫¶ÂÖãÈ£éÂíåÊàëËØ¥ËØùÂêßÔΩû'
      await playVoice(`welcome-${novelId}`, welcomeText)
    }

    window.startVoiceInput = startVoiceInput
    window.sendVoiceChat = sendVoiceChat
    window.playVoice = playVoice
    window.playWelcomeVoice = playWelcomeVoice

    // ========== Character Chat Functions ==========

    function startCharacterChat(novelId, novelTitle, genre) {
      const btn = document.getElementById(`char-voice-btn-${novelId}`)
      const status = document.getElementById(`char-status-${novelId}`)

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
      if (!SpeechRecognition) {
        status.textContent = '‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÔºåËØ∑‰ΩøÁî® Chrome'
        return
      }

      if (currentRecognition) {
        currentRecognition.stop()
        return
      }

      const recognition = new SpeechRecognition()
      recognition.lang = 'zh-CN'
      recognition.continuous = false
      recognition.interimResults = true

      recognition.onstart = () => {
        btn.classList.add('recording')
        btn.textContent = '‚èπÔ∏è'
        status.textContent = 'üé§ ÊàëÂú®Âê¨...'
      }

      recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('')
        document.getElementById(`char-input-${novelId}`).value = transcript
        status.textContent = `üìù ${transcript}`
      }

      recognition.onend = () => {
        btn.classList.remove('recording')
        btn.textContent = 'üé§'
        currentRecognition = null

        const input = document.getElementById(`char-input-${novelId}`)
        if (input.value.trim()) {
          sendCharacterChat(novelId, novelTitle, genre)
        } else {
          status.textContent = ''
        }
      }

      recognition.onerror = (event) => {
        btn.classList.remove('recording')
        btn.textContent = 'üé§'
        status.textContent = `‚ùå ${event.error}`
        currentRecognition = null
      }

      currentRecognition = recognition
      recognition.start()
    }

    async function sendCharacterChat(novelId, novelTitle, genre) {
      const input = document.getElementById(`char-input-${novelId}`)
      const sendBtn = document.getElementById(`char-send-${novelId}`)
      const voiceBtn = document.getElementById(`char-voice-btn-${novelId}`)
      const speechText = document.getElementById(`speech-text-${novelId}`)
      const speechPlay = document.getElementById(`speech-play-${novelId}`)
      const charWrapper = document.getElementById(`character-wrapper-${novelId}`)
      const speakingIndicator = document.getElementById(`speaking-indicator-${novelId}`)
      const status = document.getElementById(`char-status-${novelId}`)

      const message = input.value.trim()
      if (!message) return

      const chatRole = currentChatRoles[novelId] || 'heroine'
      const roleData = roleInfo[chatRole]

      if (!chatHistories[novelId]) {
        chatHistories[novelId] = []
      }

      chatHistories[novelId].push({ role: 'user', content: message })
      input.value = ''
      sendBtn.disabled = true
      voiceBtn.disabled = true

      speechText.textContent = 'ËÆ©ÊàëÊÉ≥ÊÉ≥...'
      charWrapper.classList.remove('speaking')
      charWrapper.classList.add('thinking')
      speakingIndicator.classList.add('active')
      status.textContent = 'ü§î ÊÄùËÄÉ‰∏≠...'

      try {
        const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            novelTitle,
            genre,
            novelContent: novelContents[novelId] || '',
            chatHistory: chatHistories[novelId],
            characterRole: chatRole
          }),
        })

        if (!chatResponse.ok) throw new Error('Chat failed')

        const chatData = await chatResponse.json()
        const reply = chatData.reply

        speechText.textContent = reply
        currentSpeechTexts[novelId] = reply
        chatHistories[novelId].push({ role: 'assistant', content: reply })

        charWrapper.classList.remove('thinking')
        charWrapper.classList.add('speaking')
        status.textContent = 'üîä ÁîüÊàêËØ≠Èü≥‰∏≠...'

        try {
          const ttsResponse = await fetch(`${API_BASE_URL}/api/tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: reply, voice: roleData.voice }),
          })

          if (ttsResponse.ok) {
            const ttsData = await ttsResponse.json()
            if (ttsData.audio) {
              const audio = new Audio(`data:${ttsData.mimeType};base64,${ttsData.audio}`)
              currentAudio = audio

              speechPlay.classList.add('playing')
              speechPlay.textContent = '‚è∏Ô∏è'
              status.textContent = ''

              audio.onended = () => {
                speechPlay.classList.remove('playing')
                speechPlay.textContent = 'üîä'
                charWrapper.classList.remove('speaking')
                speakingIndicator.classList.remove('active')
                currentAudio = null
              }

              await audio.play()
            }
          }
        } catch (ttsError) {
          console.error('TTS error:', ttsError)
          charWrapper.classList.remove('speaking')
          speakingIndicator.classList.remove('active')
        }

        status.textContent = ''

      } catch (error) {
        console.error('Character chat error:', error)
        speechText.textContent = 'Êä±Ê≠âÔºåÊàëÁé∞Âú®ÊúâÁÇπÈóÆÈ¢ò... üíî'
        charWrapper.classList.remove('thinking', 'speaking')
        speakingIndicator.classList.remove('active')
        status.textContent = ''
      } finally {
        sendBtn.disabled = false
        voiceBtn.disabled = false
      }
    }

    async function playCurrentSpeech(novelId) {
      const text = currentSpeechTexts[novelId] || 'Âó®ÔΩûÁÇπÂáª‰∏ãÈù¢ÁöÑÈ∫¶ÂÖãÈ£éÂíåÊàëËÅäÂ§©ÂêßÔΩû'
      const speechPlay = document.getElementById(`speech-play-${novelId}`)
      const charWrapper = document.getElementById(`character-wrapper-${novelId}`)
      const speakingIndicator = document.getElementById(`speaking-indicator-${novelId}`)

      const chatRole = currentChatRoles[novelId] || 'heroine'
      const voice = roleInfo[chatRole]?.voice || 'nova'

      if (currentAudio) {
        currentAudio.pause()
        currentAudio = null
        speechPlay.classList.remove('playing')
        speechPlay.textContent = 'üîä'
        charWrapper.classList.remove('speaking')
        speakingIndicator.classList.remove('active')
        return
      }

      speechPlay.textContent = '‚è≥'
      charWrapper.classList.add('speaking')
      speakingIndicator.classList.add('active')

      try {
        const response = await fetch(`${API_BASE_URL}/api/tts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, voice }),
        })

        if (response.ok) {
          const data = await response.json()
          if (data.audio) {
            const audio = new Audio(`data:${data.mimeType};base64,${data.audio}`)
            currentAudio = audio

            speechPlay.classList.add('playing')
            speechPlay.textContent = '‚è∏Ô∏è'

            audio.onended = () => {
              speechPlay.classList.remove('playing')
              speechPlay.textContent = 'üîä'
              charWrapper.classList.remove('speaking')
              speakingIndicator.classList.remove('active')
              currentAudio = null
            }

            await audio.play()
          }
        }
      } catch (error) {
        console.error('Play speech error:', error)
        speechPlay.textContent = 'üîä'
        charWrapper.classList.remove('speaking')
        speakingIndicator.classList.remove('active')
      }
    }

    window.startCharacterChat = startCharacterChat
    window.sendCharacterChat = sendCharacterChat
    window.playCurrentSpeech = playCurrentSpeech

    // Continue Novel
    async function continueNovel(novelId, novelTitle, genre) {
      const promptInput = document.getElementById(`continue-prompt-${novelId}`)
      const btn = document.getElementById(`continue-btn-${novelId}`)
      const resultContainer = document.getElementById(`continuation-result-${novelId}`)
      const textContainer = document.getElementById(`continuation-text-${novelId}`)

      const direction = promptInput.value.trim()
      const novelContent = novelContents[novelId] || ''

      if (!direction) {
        alert('ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÁúãÁöÑÂâßÊÉÖÂèëÂ±ïÔºÅ')
        promptInput.focus()
        return
      }

      if (!novelContent) {
        alert('Â∞èËØ¥ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïÁª≠ÂÜô')
        return
      }

      btn.disabled = true
      btn.textContent = '‚è≥ Áª≠ÂÜô‰∏≠...'
      resultContainer.style.display = 'block'
      textContainer.innerHTML = '<p style="color: rgba(255,255,255,0.5);">AI Ê≠£Âú®Âàõ‰Ωú‰∏≠ÔºåËØ∑Á®çÂÄô...</p>'

      try {
        const response = await fetch(`${API_BASE_URL}/api/continue-novel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            novelTitle,
            genre,
            novelContent,
            direction
          }),
        })

        if (!response.ok) {
          const error = await response.json()
          throw new Error(error.error || 'Failed to continue novel')
        }

        const data = await response.json()

        if (data.continuation) {
          const formatted = data.continuation
            .split('\n')
            .map(line => line.trim() ? `<p>${line}</p>` : '')
            .join('')

          textContainer.innerHTML = formatted || '<p>ÁîüÊàêÂÆåÊàê</p>'
        } else {
          throw new Error('No continuation generated')
        }

        promptInput.value = ''
      } catch (error) {
        console.error('Continuation error:', error)
        textContainer.innerHTML = `<p style="color: rgba(245,87,108,0.8);">‚ùå Áª≠ÂÜôÂ§±Ë¥•: ${error.message}</p>`
      } finally {
        btn.disabled = false
        btn.textContent = 'üìù ÁîüÊàêÂâßÊÉÖ'
      }
    }

    window.generateSceneImage = generateSceneImage
    window.sendChat = sendChat
    window.continueNovel = continueNovel

    // Close modal
    function closeModal() {
      document.getElementById('novel-modal').classList.remove('active')
    }

    // Get currency symbol
    function getCurrencySymbol(currency) {
      const symbols = {
        'USD': '$',
        'CNY': '¬•',
        'EUR': '‚Ç¨'
      }
      return symbols[currency] || '$'
    }

    document.getElementById('novel-modal').addEventListener('click', (e) => {
      if (e.target.id === 'novel-modal') {
        closeModal()
      }
    })

    window.showNovelDetail = showNovelDetail
    window.closeModal = closeModal
    window.handlePurchase = handlePurchase

    // Load novels on page load
    loadNovels()

    // Timeout fallback
    setTimeout(() => {
      const container = document.getElementById('novels-container')
      if (container && container.querySelector('.loading')) {
        container.innerHTML = `
          <div class="empty-state">
            <h2>Âä†ËΩΩË∂ÖÊó∂</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">ËØ∑Ê±ÇÊó∂Èó¥ËøáÈïøÔºåÈÄöÂ∏∏ÊòØ CORS ÈÖçÁΩÆÈóÆÈ¢ò„ÄÇ</p>
            <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.25); padding: 16px; border-radius: 14px; margin: 14px 0; text-align: left; max-width: 480px; margin-left: auto; margin-right: auto;">
              <h3 style="margin: 0 0 10px; color: #fbbf24; font-size: 14px;">‚ö†Ô∏è ÈúÄË¶ÅÈÖçÁΩÆ CORS</h3>
              <p style="margin: 0; color: rgba(251,191,36,0.8); font-size: 13px; line-height: 1.7;">
                1. ËÆøÈóÆ <a href="https://www.sanity.io/manage" target="_blank" style="color: #fbbf24;">sanity.io/manage</a><br>
                2. ÈÄâÊã©È°πÁõÆ <strong>9cp0f5xw</strong><br>
                3. API ‚Üí CORS origins ‚Üí Ê∑ªÂä†ÂΩìÂâçÂüüÂêç<br>
                4. ÂãæÈÄâ Allow credentials ‚Üí ‰øùÂ≠ò
              </p>
            </div>
            <button onclick="location.reload()" style="padding: 12px 28px; background: linear-gradient(135deg, #667eea, #f093fb); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; font-family: inherit;">
              ÈáçÊñ∞Âä†ËΩΩ
            </button>
          </div>
        `
      }
    }, 10000)
  </script>
</body>
</html>
